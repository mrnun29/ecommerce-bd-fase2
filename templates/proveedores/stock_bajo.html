{% extends 'base.html' %}

{% block title %}Stock Bajo - Proveedores{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2><i class="bi bi-exclamation-triangle text-warning"></i> Productos con Stock Bajo</h2>
        <p class="text-muted">Productos que necesitan ser reabastecidos</p>
    </div>
</div>

<div class="row">
    <div class="col-12">
        {% if productos %}
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Producto</th>
                                <th>Stock Actual</th>
                                <th>Nivel Mínimo</th>
                                <th>Diferencia</th>
                                <th>Precio</th>
                                <th>Reabastecer</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for producto in productos %}
                            <tr>
                                <td>{{ producto.id_producto }}</td>
                                <td>
                                    <strong>{{ producto.nombre }}</strong><br>
                                    <small class="text-muted">{{ producto.descripcion[:50] }}...</small>
                                </td>
                                <td>
                                    <span class="badge bg-danger">{{ producto.stock }}</span>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ producto.nivel_minimo }}</span>
                                </td>
                                <td>
                                    <span class="badge bg-warning text-dark">
                                        {{ producto.nivel_minimo - producto.stock }} unidades faltantes
                                    </span>
                                </td>
                                <td>${{ "%.2f"|format(producto.precio) }}</td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-success" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#modalReabastecer{{ producto.id_producto }}">
                                        <i class="bi bi-box-arrow-in-down"></i> Reabastecer
                                    </button>

                                    <!-- Modal para reabastecer -->
                                    <div class="modal fade" id="modalReabastecer{{ producto.id_producto }}" tabindex="-1">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title">Reabastecer: {{ producto.nombre }}</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                </div>
                                                <form method="POST" action="{{ url_for('reabastecer_producto') }}">
                                                    <div class="modal-body">
                                                        <input type="hidden" name="id_producto" value="{{ producto.id_producto }}">
                                                        
                                                        <div class="alert alert-info">
                                                            <strong>Stock actual:</strong> {{ producto.stock }} unidades<br>
                                                            <strong>Nivel mínimo:</strong> {{ producto.nivel_minimo }} unidades<br>
                                                            <strong>Recomendado:</strong> {{ (producto.nivel_minimo - producto.stock) + 20 }} unidades
                                                        </div>

                                                        <div class="mb-3">
                                                            <label class="form-label">Proveedor</label>
                                                            <select name="id_proveedor" class="form-select" required>
                                                                <option value="">Selecciona un proveedor</option>
                                                                {% for proveedor in proveedores %}
                                                                <option value="{{ proveedor.id_proveedor }}">
                                                                    {{ proveedor.empresa }} - {{ proveedor.contacto }}
                                                                </option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>

                                                        <div class="mb-3">
                                                            <label class="form-label">Cantidad a reabastecer</label>
                                                            <input type="number" name="cantidad" class="form-control" 
                                                                   min="1" value="{{ (producto.nivel_minimo - producto.stock) + 20 }}" required>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                                        <button type="submit" class="btn btn-success">
                                                            <i class="bi bi-check-circle"></i> Confirmar Reabastecimiento
                                                        </button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-success">
            <i class="bi bi-check-circle"></i> <strong>¡Excelente!</strong> No hay productos con stock bajo en este momento.
        </div>
        {% endif %}
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <i class="bi bi-box-seam display-4 text-danger"></i>
                <h5 class="mt-3">Productos Críticos</h5>
                <h2 class="text-danger">{{ productos|length }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <i class="bi bi-building display-4 text-primary"></i>
                <h5 class="mt-3">Proveedores Disponibles</h5>
                <h2 class="text-primary">{{ proveedores|length }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <i class="bi bi-truck display-4 text-success"></i>
                <h5 class="mt-3">Acción Requerida</h5>
                <p class="mb-0">Reabastecer productos marcados en rojo</p>
            </div>
        </div>
    </div>
</div>

<div class="row mt-3">
    <div class="col-12">
        <a href="{{ url_for('proveedores_lista') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Volver a Proveedores
        </a>
    </div>
</div>
{% endblock %}
